{% extends 'complaints/base.html' %}

{% block title %}Report Issue - Civic Issue Reporting System{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0">
                    <i class="bi bi-plus-circle"></i> Report a New Issue
                </h2>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="{{ form.title.id_for_label }}" class="form-label">
                                {{ form.title.label }}
                            </label>
                            {{ form.title }}
                            {% if form.title.errors %}
                                <div class="text-danger">
                                    {% for error in form.title.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.category.id_for_label }}" class="form-label">
                                {{ form.category.label }}
                            </label>
                            {{ form.category }}
                            {% if form.category.errors %}
                                <div class="text-danger">
                                    {% for error in form.category.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.location.id_for_label }}" class="form-label">
                                {{ form.location.label }}
                            </label>
                            {{ form.location }}
                            {% if form.location.errors %}
                                <div class="text-danger">
                                    {% for error in form.location.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Google Maps Location Picker -->
                    <div class="mb-4">
                        <label class="form-label">
                            <i class="bi bi-geo-alt-fill"></i> Select Location on Map
                        </label>
                        <div id="map" style="height: 400px; width: 100%; border-radius: 8px; border: 2px solid #dee2e6;"></div>
                        <div class="form-text mt-2">
                            <i class="bi bi-info-circle"></i> 
                            Click on the map or drag the marker to select the exact location of the issue
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">
                            {{ form.description.label }}
                        </label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="text-danger">
                                {% for error in form.description.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-4">
                        <label for="{{ form.image.id_for_label }}" class="form-label">
                            {{ form.image.label }}
                        </label>
                        {{ form.image }}
                        {% if form.image.errors %}
                            <div class="text-danger">
                                {% for error in form.image.errors %}
                                    <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i> 
                            Upload an image to help describe the issue (optional)
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'complaints:home' %}" class="btn btn-outline-secondary me-md-2">
                            <i class="bi bi-arrow-left"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Submit Complaint
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Help Section -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-question-circle"></i> How to Report an Issue
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="bi bi-1-circle text-primary"></i> Be Specific</h6>
                        <p class="text-muted small">Provide a clear, descriptive title and detailed description of the issue.</p>
                        
                        <h6><i class="bi bi-2-circle text-primary"></i> Include Location</h6>
                        <p class="text-muted small">Specify the exact location where the issue is occurring.</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="bi bi-3-circle text-primary"></i> Choose Category</h6>
                        <p class="text-muted small">Select the most appropriate category for your complaint.</p>
                        
                        <h6><i class="bi bi-4-circle text-primary"></i> Add Photos</h6>
                        <p class="text-muted small">Upload photos to help authorities understand the issue better.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize Google Maps
    let map;
    let marker;
    let geocoder;
    
    function initMap() {
        const defaultCenter = { lat: 28.6139, lng: 77.2090 }; // Default to New Delhi, India
        
        // Initialize map
        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 13,
            center: defaultCenter,
            mapTypeControl: true,
            streetViewControl: true,
            fullscreenControl: true,
        });
        
        // Initialize geocoder
        geocoder = new google.maps.Geocoder();
        
        // Try to get user's current location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    map.setCenter(userLocation);
                    placeMarker(userLocation);
                },
                function() {
                    // If geolocation fails, use default center
                    placeMarker(defaultCenter);
                }
            );
        } else {
            // Browser doesn't support geolocation
            placeMarker(defaultCenter);
        }
        
        // Add click listener to map
        map.addListener("click", function(event) {
            placeMarker(event.latLng);
        });
    }
    
    function placeMarker(location) {
        // Remove existing marker if any
        if (marker) {
            marker.setMap(null);
        }
        
        // Get coordinates (handle both LatLng objects and plain objects)
        let lat, lng;
        if (typeof location.lat === 'function') {
            // It's a LatLng object
            lat = location.lat();
            lng = location.lng();
        } else {
            // It's a plain object
            lat = location.lat;
            lng = location.lng;
        }
        
        // Create new marker
        marker = new google.maps.Marker({
            position: { lat: lat, lng: lng },
            map: map,
            draggable: true,
            animation: google.maps.Animation.DROP,
            title: "Issue Location"
        });
        
        // Update location field with coordinates
        const locationText = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        document.getElementById("id_location").value = locationText;
        
        // Try to reverse geocode to get address (only if geocoder is available)
        if (geocoder) {
            geocoder.geocode({ location: { lat: lat, lng: lng } }, function(results, status) {
                if (status === "OK" && results[0]) {
                    document.getElementById("id_location").value = results[0].formatted_address;
                }
            });
        }
        
        // Add drag listener to marker
        marker.addListener("dragend", function(event) {
            const newLocation = marker.getPosition();
            const newLat = newLocation.lat();
            const newLng = newLocation.lng();
            
            const locationText = `${newLat.toFixed(6)}, ${newLng.toFixed(6)}`;
            document.getElementById("id_location").value = locationText;
            
            // Try to reverse geocode new position
            if (geocoder) {
                geocoder.geocode({ location: { lat: newLat, lng: newLng } }, function(results, status) {
                    if (status === "OK" && results[0]) {
                        document.getElementById("id_location").value = results[0].formatted_address;
                    }
                });
            }
        });
    }
    
    // Load Google Maps script - without API key requirement
    window.initMap = initMap;
</script>
<script async defer 
    src="https://maps.googleapis.com/maps/api/js?callback=initMap&libraries=places">
</script>
{% endblock %}